---
title: "Tree inference"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tree_inference}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)

options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup}
library(treepplr)
library(dplyr)
library(ggplot2)
library(ape)
```

## 
```{r, eval=FALSE}
exe_path <- tp_compile(model = "tree_inference_pruning", method = "smc-apf", particles = 1000, 
                       resample = "manual")
data_path <- tp_data("tree_inference_pruning")

output_list <- tp_run(exe_path, data_path, n_sweeps = 10)
```

```{r, echo=FALSE}
output_list <- readRDS("rdata/tree_inference/output_tree_inference.rds")
```

The result is a list of sweeps, each one containing 3 elements: the sampled 
parameter values and the weights (in log scale) for each of the 5 particles in 
each sweep, and the normalizing constant for the whole sweep.

```{r}
str(output_list,max.level = 2)
```

## Plot the posterior distribution

In this example we will check that the different runs converged to the same posterior,
by checking the variance in the normalizing constant among runs.

# not working
```{r, fig.height=5, fig.width=5}
output <- tp_parse_smc(output_list)
tp_smc_convergence(output)
```

There are different ways to summarize the posterior distribution of trees. In
this examples, we calculate the the MAP (Maximum A Posteriori) tree. We do this 
by finding the single tree topology that has the highest posterior probability, 
and then using `ape::consensus` to compute average branch lengths for all sampled
trees with the MAP topology.

# not working
```{r, fig.height=4, fig.width=5}
out_trees <- tp_json_to_phylo(output_list)

map_tree <- tp_map_tree(out_trees)
plot(map_tree)
axisPhylo()
```
