---
title: "Constant rate birth-death (CRBD) model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Constant-Rate-Birth}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)

options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup}
library(treepplr)
library(ape)
library(ggplot2)
```


## Data

We will use an example (random) tree that comes with the package.

```{r, fig.width=6, fig.height=4}
tree <- ape::read.tree(system.file(
  "extdata/crb_tree_15_tips.tre", package = "treepplr"))
ape::plot.phylo(tree, cex = 0.5)
ape::axisPhylo()
```

Then, we need to produce a file with the necessary input for the CRBD model 
(a tree and the parameter rho), in a **TreePPL** readable format.

```{r}
data_path <- tp_data(list(tree = tree, rho = 2.0))
```


## Run treeppl

Compile the TreePPL program with standard inference settings.

```{r, eval=FALSE}
exe_path <- tp_compile(model = "crbd", method = "smc-bpf", particles = 2000)
```

Now run SMC inference under the CRBD model, using the data.

```{r, eval=FALSE}
output <- tp_run(exe_path, data_path, n_sweeps = 1)
```


```{r, echo=FALSE}
output_list <- readRDS("rdata/crb/output_crb.rds")
```


## Plot posterior

TreePPL outputs the log weight of each sample, so first we need to get the
normalized weights and then we can plot the posterior distribution produced.

```{r, fig.height=4, fig.width=6}
# turn list into a data frame where each row represents one sample
# and calculate normalized weights from log weights and normalizing constants.
output <-  tp_parse(output_list) %>%
  dplyr::mutate(total_lweight = log_weight + norm_const) %>%
  dplyr::mutate(norm_weight = exp(total_lweight - max(.$total_lweight)))

ggplot2::ggplot(output, ggplot2::aes(samples, weight = norm_weight)) +
  ggplot2::geom_histogram(ggplot2::aes(y = ggplot2::after_stat(density)),
                 col = "white", fill = "lightblue", binwidth=0.04) +
  ggplot2::geom_density() +
  ggplot2::theme_bw()

```

